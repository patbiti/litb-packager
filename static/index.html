<!DOCTYPE html>
<html lang="en">
<head>
 <script type="text/javascript" src="/socket.io/socket.io.js"></script>
  <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
  <script src="http://libs.baidu.com/bootstrap/2.3.2/js/bootstrap.min.js"></script>
  <link href="http://libs.baidu.com/bootstrap/2.3.2/css/bootstrap.min.css" rel="stylesheet">

  <style>
    div.status{
      background:#000;
      color:#FFF;
      font-weight:bold;
      float:left;
      position: relative;
      padding-top:25px;
    }
    div.status:after{
      content: "status";
      position: absolute;
      top: -1px;
      left: -1px;
      padding: 3px 7px;
      font-size: 12px;
      font-weight: bold;
      background-color: #f5f5f5;
      border: 1px solid #ddd;
      color: #9da0a4;
      -webkit-border-radius: 4px 0 4px 0;
      -moz-border-radius: 4px 0 4px 0;
      border-radius: 4px 0 4px 0;
    }
    div.show:after{
      content: "terminal";
    }
    div.email:after{
      content: "email";
    }
  </style>

<script>
  var socket = io.connect(window.location.origin);
</script>
</head>
<body>
  <header>
    <div class="container">
      <div class="page-header">
        <h1>litb-riapackger system</h1>
      </div>
      <p>打包系统</p>
    </div>
  </header>
  <div class="container">
    <ul class="nav nav-tabs">
     
      <li><a  node-type="packager" href="#packager">打包</a></li>
       <li class="active"><a node-type="switch" href="#switch">切换分支</a></li>
    </ul>
    <div class="switch inputzone">
      <p class="text-info">用于UI测试的分支切换和更新【定时任务2分钟更新一次。】。http://fe.tbox.me:8888/ria.lightsource</p>
      <form class="form-search">
        <input type="text" class="input-medium search-query" placeholder="master" name="branch" />
        <button type="button" class="btn">切换</button>
      </form>
    </div>
    <div class="packager inputzone">
      <p class="text-info">打包</p>
      <label class="radio">
        <input type="radio" name="packtype" value="1" checked>
       测试打包使用该选项【需要输入分支名，包名】
      </label>
      <label class="radio">
        <input type="radio" name="packtype" value="2">
        上线打包暂时使用该选项，上线前请合并主干，从master打包，comments必填。
      </label>
      <label class="radio">
        <input type="radio" name="packtype" value="3">
        给测试的同学提供最新的master包名称。
      </label>
      <form class="form-inline">
        <input type="text" class="input-small" placeholder="master" name="branch" isMust="must" />
        <input type="text" class="input-small" placeholder="版本号，如：1.3.2.1" isMust="must" name="packagerno" />
        <input type="text" class="input-small" placeholder="注释" name="comments" style="display:none"/>
        <button type="button" class="btn">packager</button>
        <br/>
        <p node-type="show-comments"></p>
        <p>邮件内容</p>
        <button type="button" class="btn">发送邮件</button>
      </form>
    </div>
  </div>
  <div class="container">
    <div style="height:400px;">
      <div id="show" style="width:600px;height:400px;overflow-y:scroll;" class="status show"></div>
      <div style="float:left;width:200px;height:400px;text-align:center;border-right:1px solid #FFF;height:400px;" class="status">
        <div id="status_info"></div>
        <div id="status" ></div>
      </div>
    </div>
  </div>


  <script>
    var init = function(){
      var key = window.location.hash == '' ? 'packager':window.location.hash.split('#')[1];
      showTab(key);
    }
    var showTab = function(key){
      $('.inputzone').hide();
      $('.' + key).show();
      $('.nav-tabs li').removeClass('active');
      $('[node-type="' + key+'"]').parent().addClass('active');
    }
    var runningInterval;
    var statusRuning = {
      timer : null,
      start : function(){
        statusRuning.timer = setInterval(function(){
          $('#status').html($('#status').html() == '......' ? '' : $('#status').html() + '.');
        },1000);
      },
      stop : function(){
        clearInterval(statusRuning.timer);
        $('#status').html('');
      }
    }
    var updateContent = function(content){
      $('#show').append(content);
      $('#show').scrollTop($('#show')[0].scrollHeight);
    }
    var startCommand = function(obj){
      obj.attr('disabled', true);
      $('#show').html('');
      var info = '<p>command excuting</p>';
      $('#status_info').html(info);
      statusRuning.start();
    }

    var checkMust = function(obj){
      var inputs = obj.find('input[isMust="must"]');
      if(inputs.length ===0){
        return true;
      }
      for(var i=0;i<inputs.length;i++){
        if($.trim(inputs.eq(i).val())==''){
          inputs.eq(i).focus();
          return false;
        }
      }
      return true;
    }
  //switch branch
    var switchZone = $('.switch');
    switchZone.find('button').click(function(){
      startCommand($(this));
      var inputVal = $.trim(switchZone.find('input').val()) == '' ? 'master' : $.trim(switchZone.find('input').val());
      socket.emit('git_update',{'data':inputVal});
    });

   //commont  on
   var packZone = $('.packager');
   packZone.find('button').click(function(){
    if(!checkMust(packZone)){
      return false;
    }
    startCommand($(this));
    var data = {};
    data['type'] = packZone.find('input[name="packtype"]:checked').val();
    data['branch'] = $.trim(packZone.find('[name="branch"]').val());
    data['packagerno'] = $.trim(packZone.find('[name="packagerno"]').val());
    socket.emit('packager', data)
   });

   packZone.find('input[type="radio"]').click(function(){
      var type = $(this).val();
      if(type==1){
        packZone.find('[name="branch"]').show().attr('readonly',false).val('');
        packZone.find('[name="packagerno"]').show().attr('readonly',false).val('');
        packZone.find('[name="comments"]').hide().val('').removeAttr('isMust');
      }else if(type=="2"){
        packZone.find('[name="branch"]').show().val('master').attr('readonly',true);
        packZone.find('[name="packagerno"]').show().attr('readonly',false).val('');
        packZone.find('[name="comments"]').show().attr('isMust','must');
      }else{
        packZone.find('[name="branch"]').show().val('master').attr('readonly',true);
        packZone.find('[name="packagerno"]').show().attr('readonly',true).val('latest');
        packZone.find('[name="comments"]').hide().val('').attr('isMust','must');
      }
   });
    socket.on('exit_info', function(data){
      $('button').attr('disabled', false);
      statusRuning.stop();
      var info = '<p>' + data.result  + '</p>';
      info = info + '<p>command ' + data.actionType  + 'excute over</p>';
      $('#status_info').html(info);
    });

    //1
    socket.on('git_renew', function(data){
      updateContent(data.result);
    });
  //init

    init();
    $('.nav-tabs a').click(function(){
      showTab($(this).attr('node-type'));
    })
  </script>




<!--test-->

<br/>
<div class="showzone switch">
  <h1>swith the git for ui-test or cc</h1>
  <button type="button" class="btn btn-primary" >switch</button><br/>
  <input type="text" placeholder="master" id="branch"/>
</div>
<button id="choose">choose</button>
<!-- <button id="packager">pack</button> -->
<button id="show_list">Show List</button>

<button id="email">email</button><br/>

<input type="text" placeholder="version:1.3.0" id="version"/>
<input type="text" placeholder="comments" id="comments"/>
<br/>

</body>
<script>
  // document.getElementById('choose').onclick = function(){
  //   socket.emit('choose', { my: 'data1' });
  // }
  // document.getElementById('packager').onclick = function(){
  //   this.disabled="disabled";
  //   document.getElementById('show').innerHTML = '';
  //   document.getElementById('status').innerHTML = '<p>command packager excuting!</p>'; 
  //   socket.emit('packager', { my: 'data2' });
  // }
  // document.getElementById('show_list').onclick = function(){
  //   document.getElementById('status').innerHTML = '<p>command excuting!</p>'; 
  //   socket.emit('show', {});
  // }
  socket.on('action', function(data){
    document.getElementById('show').innerHTML = document.getElementById('show').innerHTML + '<p>' + data.event + '</p>'; 
  })
  socket.on('show_result', function(data){
    document.getElementById('show').innerHTML =  '<p>' + beatify(data.result) + '</p>'; 
  })

  socket.on('show_result_lasting', function(data){
    document.getElementById('show').innerHTML = document.getElementById('show').innerHTML +   '<p>' + (data.result) + '</p>'; 
  })
  socket.on('file_list', function(data){
    var list = data.result;
    var htmlArr = [];
    for(i=0;i<list.length;i++){
      if(list[i].indexOf('.tgz')>-1){
        htmlArr.push('<p><label><input type="radio" name="filelist" value="');
        htmlArr.push(list[i]);
        htmlArr.push('"/>');
        htmlArr.push(list[i]);
        htmlArr.push('</label></p>');
      }
    }
    document.getElementById('show').innerHTML = htmlArr.join('');
  })
  function beatify(data){
    return data.replace(/\n/g, "<br />");
  }
  function initMail(){
    
  }
  
  
</script>
</html>
